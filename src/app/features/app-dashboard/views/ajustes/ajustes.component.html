<section class="max-w-7xl mx-auto" aria-labelledby="ajustes-title">
  <header class="mb-6">
    <h1 id="ajustes-title" class="text-3xl font-semibold text-[#003865]">Ajustes</h1>
    <div aria-hidden="true" class="h-px bg-[#FDD26E] mt-2 mb-6 w-full"></div>
  </header>

  <!-- PERFIL -->
  <section aria-labelledby="perfil-title" class="mb-10">
    <h2 id="perfil-title" class="text-xl font-semibold text-[#00C1D4] mb-4">Perfil</h2>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Columna izquierda: inputs -->
      <div class="lg:col-span-2">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-700 mb-1">Nombres</label>
            <input [(ngModel)]="firstName" type="text" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-[#00C1D4]" />
          </div>
          <div>
            <label class="block text-sm text-gray-700 mb-1">Apellidos</label>
            <input [(ngModel)]="lastName" type="text" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-[#00C1D4]" />
          </div>
          <div>
            <label class="block text-sm text-gray-700 mb-1">Puesto</label>
            <input [(ngModel)]="position" type="text" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-[#00C1D4]" />
          </div>
          <div>
            <label class="block text-sm text-gray-700 mb-1">Departamento</label>
            <input [(ngModel)]="department" type="text" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-[#00C1D4]" />
          </div>
        </div>

        <div class="mt-4">
          <button (click)="updateProfile()" class="px-4 py-2 rounded-lg bg-[#00C1D4] text-white font-medium hover:opacity-90 focus:ring-2 focus:ring-offset-2 focus:ring-[#00C1D4]">
            Actualizar
          </button>
        </div>
      </div>

      <!-- Columna derecha: foto -->
      <div class="bg-white rounded-2xl p-5 border border-[#00C1D4]">
        <h3 class="text-[#003865] font-medium mb-3">Foto de Perfil</h3>
        <div class="flex gap-3 mb-3">
          <label class="flex-1">
            <input type="file" accept="image/*" class="hidden" (change)="onFileSelect($event)" />
            <span class="w-full inline-flex justify-center px-4 py-2 rounded-lg bg-[#FFB81C] text-[#003865] font-semibold cursor-pointer hover:opacity-90">Subir Archivo</span>
          </label>

          <button type="button" (click)="openCamera()" class="flex-1 px-4 py-2 rounded-lg bg-[#FFB81C] text-[#003865] font-semibold hover:opacity-90">
            Tomar Fotografía
          </button>
        </div>

        <!-- Cámara -->
        <div *ngIf="showCamera" class="mb-3">
          <video id="videoCam" autoplay playsinline class="w-full rounded-lg bg-black/10"></video>
          <div class="flex gap-2 mt-2">
            <button (click)="capturePhoto()" class="px-4 py-2 rounded-lg bg-[#00C1D4] text-white">Capturar</button>
            <button (click)="closeCamera()" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-800">Cancelar</button>
          </div>
        </div>

        <div class="flex justify-center">
          <img
            [src]="(previewPhoto || me?.photoURL) || 'assets/avatar.png'"
            alt="Avatar de perfil"
            class="w-28 h-28 rounded-full object-cover border-4 border-white shadow"
          />
        </div>

        <p *ngIf="uploading" class="text-sm text-gray-500 mt-2 text-center">Subiendo...</p>
      </div>
    </div>
  </section>

  <!-- CONTRASEÑA -->
  <section aria-labelledby="pass-title" class="mb-10">
    <h2 id="pass-title" class="text-xl font-semibold text-[#00C1D4] mb-4">Contraseña</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
      <div>
        <label class="block text-sm text-gray-700 mb-1">Contraseña actual</label>
        <input [(ngModel)]="currentPassword" type="password" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-[#00C1D4]" />
      </div>
     
      <div class="md:col-span-1">
        <label class="block text-sm text-gray-700 mb-1">Contraseña nueva</label>
        <input [(ngModel)]="newPassword" type="password" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-[#00C1D4]" />
      </div>
       <div>
        <label class="block text-sm text-gray-700 mb-1">Confirmar contraseña</label>
        <input [(ngModel)]="confirmPassword" type="password" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-[#00C1D4]" />
      </div>
      <div class="md:col-span-1 flex md:justify-end">
        <button (click)="changePassword()" [disabled]="changing"
          class="px-4 py-2 rounded-lg bg-[#003865] text-white font-medium hover:opacity-90 disabled:opacity-50">
          Cambiar contraseña
        </button>
      </div>
    </div>
    <p *ngIf="passMsg" class="mt-2 text-sm" [class.text-green-700]="passMsg.includes('actualizada')" [class.text-red-600]="!passMsg.includes('actualizada')">{{ passMsg }}</p>
  </section>

  <!-- CREAR USUARIO (solo admin) -->
  <section *ngIf="isAdmin" aria-labelledby="crear-title" class="mb-10">
    <h2 id="crear-title" class="text-xl font-semibold text-[#00C1D4] mb-4">Crear Usuario</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm text-gray-700 mb-1">Nombres</label>
        <input [(ngModel)]="cu_firstName" type="text" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:ring-2 focus:ring-[#00C1D4]" />
      </div>
      <div>
        <label class="block text-sm text-gray-700 mb-1">Puesto</label>
        <input [(ngModel)]="cu_position" type="text" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:ring-2 focus:ring-[#00C1D4]" />
      </div>

      <div>
        <label class="block text-sm text-gray-700 mb-1">Apellidos</label>
        <input [(ngModel)]="cu_lastName" type="text" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:ring-2 focus:ring-[#00C1D4]" />
      </div>
      <div>
        <label class="block text-sm text-gray-700 mb-1">Departamento</label>
        <input [(ngModel)]="cu_department" type="text" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:ring-2 focus:ring-[#00C1D4]" />
      </div>

      <div>
        <label class="block text-sm text-gray-700 mb-1">Correo</label>
        <input [(ngModel)]="cu_email" type="email" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:ring-2 focus:ring-[#00C1D4]" />
      </div>
      <div>
        <label class="block text-sm text-gray-700 mb-1">Rol</label>
        <select [(ngModel)]="cu_role" class="w-full px-3 py-2 rounded-lg bg-gray-100 focus:ring-2 focus:ring-[#00C1D4]">
          <option value="admin">Administrador</option>
          <option value="lector">Lector</option>
        </select>
      </div>
    </div>

    <div class="mt-4 flex justify-end">
      <button (click)="createUser()" [disabled]="savingUser"
        class="px-4 py-2 rounded-lg bg-[#00C1D4] text-white font-medium hover:opacity-90 disabled:opacity-50">
        Guardar
      </button>
    </div>
  </section>

  <!-- PIE: botón Ver todos los usuarios (solo admin) -->
  <div class="flex justify-center my-8" *ngIf="isAdmin">
    <button (click)="openUsersModal()" class="px-6 py-2 rounded-lg bg-[#FFB81C] text-[#003865] font-semibold hover:opacity-90">
      Ver todos los usuarios
    </button>
  </div>

  <!-- MODAL USUARIOS -->
  <div *ngIf="showUsers" class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50" (click)="closeUsersModal()" aria-hidden="true"></div>

    <div class="relative bg-white w-[95vw] xl:w-[85vw] h-[85vh] rounded-2xl shadow-xl border border-[#00C1D4] flex flex-col">
      <header class="flex items-center justify-between p-4 border-b">
        <h3 class="text-2xl font-semibold text-[#003865]">Usuarios</h3>
        <button (click)="closeUsersModal()" class="p-2 rounded hover:bg-gray-100" aria-label="Cerrar">
          <i class="fa-solid fa-xmark text-[#FFB81C] text-2xl"></i>
        </button>
      </header>

      <!-- Barra de controles -->
      <div class="p-4 flex flex-wrap items-center gap-3 border-b">
        <div class="text-[#003865] font-medium">Ordenar por:</div>
        <div class="flex gap-2">
          <button (click)="applySort('az')" class="px-3 py-1 rounded bg-[#00C1D4] text-white">A-Z</button>
          <button (click)="applySort('za')" class="px-3 py-1 rounded bg-[#FDD26E] text-[#003865]">Z-A</button>
          <button (click)="applySort('role')" class="px-3 py-1 rounded bg-[#FDD26E] text-[#003865]">Rol</button>
        </div>

        <div class="ml-auto flex items-center gap-2">
          <span class="text-[#003865] font-medium">Descargar como:</span>
          <button (click)="exportPDF()" class="px-3 py-1 rounded bg-[#00C1D4] text-white">PDF</button>
          <button (click)="exportXLSX()" class="px-3 py-1 rounded bg-[#FDD26E] text-[#003865]">Excel</button>
          <button (click)="exportCSV()" class="px-3 py-1 rounded bg-[#FDD26E] text-[#003865]">CSV</button>
        </div>
      </div>

      <!-- Tabla -->
      <div class="flex-1 overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 text-[#003865]">
            <tr>
              <th class="px-4 py-3 text-left">Nombres</th>
              <th class="px-4 py-3 text-left">Apellidos</th>
              <th class="px-4 py-3 text-left">Correo</th>
              <th class="px-4 py-3 text-left">Rol</th>
              <th class="px-4 py-3 text-left">Puesto</th>
              <th class="px-4 py-3 text-left">Departamento</th>
              <th class="px-4 py-3 text-left">Activo</th>
              <th class="px-4 py-3 text-left">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let u of usersView" class="border-t">
              <td class="px-4 py-3">
                <input [(ngModel)]="u.firstName" class="w-full bg-gray-100 rounded px-2 py-1" />
              </td>
              <td class="px-4 py-3">
                <input [(ngModel)]="u.lastName" class="w-full bg-gray-100 rounded px-2 py-1" />
              </td>
              <td class="px-4 py-3">
                <input [(ngModel)]="u.email" class="w-full bg-gray-100 rounded px-2 py-1" />
              </td>
              <td class="px-4 py-3">
                <select [(ngModel)]="u.role" class="w-full bg-gray-100 rounded px-2 py-1">
                  <option value="admin">Administrador</option>
                  <option value="lector">Lector</option>
                </select>
              </td>
              <td class="px-4 py-3">
                <input [(ngModel)]="u.position" class="w-full bg-gray-100 rounded px-2 py-1" />
              </td>
              <td class="px-4 py-3">
                <input [(ngModel)]="u.department" class="w-full bg-gray-100 rounded px-2 py-1" />
              </td>
              <td class="px-4 py-3">
                <span class="inline-flex rounded-full px-2 py-0.5 text-xs font-medium"
                  [ngClass]="u.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                  {{ u.active ? 'Sí' : 'No' }}
                </span>
              </td>
              <td class="px-4 py-3">
                <div class="flex gap-2">
                  <button (click)="saveInline(u)" class="px-3 py-1 rounded bg-[#00C1D4] text-white">Guardar</button>
                  <button (click)="deactivate(u)" class="px-3 py-1 rounded bg-[#FDD26E] text-[#003865]">Eliminar</button>
                </div>
              </td>
            </tr>

            <tr *ngIf="usersView.length === 0">
              <td colspan="8" class="px-4 py-8 text-center text-gray-500">Sin registros</td>
            </tr>
          </tbody>
        </table>
      </div>

      <footer class="p-4 border-t flex justify-end">
        <button (click)="closeUsersModal()" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-800">Cerrar</button>
      </footer>
    </div>
  </div>
</section>
